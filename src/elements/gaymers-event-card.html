<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="./moment-js.html">

<dom-module id="gaymers-event-card">
  <template>
    <style include="shared-styles">
      :host {
        display: flex;
        flex-flow: column;
        box-sizing: border-box;
        width: 100%;
        min-width: 300px;
        padding: 20px 20px 10px 20px;
        background-color: var(--gaymers-primary-light);
      }

      iron-image {
        width: calc(100% + 40px);
        position: relative;
        top: -20px;
        left: -20px;
        height: 150px;
        background-color: var(--gaymers-primary-dark);
      }

      h3 {
        margin-top: -10px;
        margin-bottom: 0px;
        color: #FFFFFF;
      }

      #times {
        margin-bottom: 20px;
      }

      span {
        color: #FFFFFF;
        font-style: italic;
        font-size: 14px;
      }

      p {
        color: #FFFFFF;
        margin-top: 0;
        margin-bottom: 1.4em;
        font-size: 14px;
      }
    </style>

    <template is="dom-if" if="{{event.image}}">
      <iron-image src="{{_calculateImageUrl(event.image)}}" sizing="cover" preload fade></iron-image>
    </template>

    <h3>{{event.title}}</h3>

    <div id="times">
      <span id="start-time">{{_calculateTimeWithTimezone(event.start)}}</span>
      <span id="separator"> - </span>
      <span id="end-time">{{_calculateTimeWithTimezone(event.end)}}</span>
    </div>

    <template is="dom-if" if="{{event.description}}">
      <template is="dom-repeat" items="{{_splitDescription(event.description)}}">
        <p>{{item}}</p>
      </template>
    </template>

    <template is="dom-if" if="[[signedIn]]">
      <template is="dom-if" if="[[attending]]">
        <button on-tap="joinEvent">Join</button>
      </template>

      <template is="dom-if" if="[[!attending]]">
        You're not attending!
      </template>
    </template>
  </template>

  <script>
    Polymer({
      is: 'gaymers-event-card',

      properties: {
        event: {
          type: Object,
        },

        user: {
          type: Object,
        },

        timezone: {
          type: String,
          value: moment.tz.guess()
        },

        description: {
          type: String,
          observer: '_splitDescription',
        },

        attending: {
          type: Boolean,
          computed: '_computeAttending(event.attendees, user.userid)' 
        },
      },

      _calculateTimeWithTimezone: function(time) {
        return moment(time).tz(this.timezone).format('ddd MMM Do, ha z');
      },

      _calculateImageUrl: function(image) {
        return '' + image;
      },

      _splitDescription: function(description) {
        var array = description.split('\n');

        for(i = 0; i < array.length; i++) {
          // Removes double returns
          if (array[i] == "") {
            array.splice(i, 1);
            i--;
          }
        }

        return array;
      },

      _computeAttending: function(attendees, userid) {
        if (!attendees) {
          return false;
        }

        if (!userid) {
          return false;
        }

        array = JSON.parse(attendees);

        for (var i = 0; i < array.length; i++) {
          if (array[i].userid === userid) {
            return true;
          }
        }

        return false;
      },

      joinEvent: function() {
        console.log('Joining Event');
        this.fire('joinEvent', { eventId: this.event.id });
      },
    });
  </script>
</dom-module>
